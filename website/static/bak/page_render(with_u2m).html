<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>MindMaster Roleplay</title>
    <link rel="stylesheet" href="../static/css/main.css">
    <link rel="stylesheet" href="../static/css/bottom_labels.css">
    <link rel="stylesheet" href="../static/css/values.css">
    <link rel="stylesheet" href="../static/css/status_sidebar.css">
    <script type="text/javascript" src="../static/js/jquery.min.js"></script>
    <script type="text/javascript" src="../static/js/echarts.min.js"></script>
    <script type="text/javascript" src="../static/js/constants.js"></script>
    <script type="text/javascript" src="../static/js/utils.js"></script>
    <script type="text/javascript" src="../static/js/labels.js"></script>
    <script type="text/javascript" src="../static/js/update.js"></script>
    <script type="text/javascript" src="../static/js/values.js"></script>
</head>

<body>
    <div class="sidebar">
        <div id="game-logo">
            <img src="../static/imgs/logo_400.png" alt="logo" id="logo">
        </div>
        <div id="intention">
            <p id="intention-para">
                My initial assigned intention: <br>
<!--                #2652DA-->
                <span class="target-state">target state:</span> <b><span style="color: rgba(10, 115, 255, 1);">"{{ intent_desc }}"</span></b>
            </p>
            <p id="other-value-para">
                {{ partner_name }}'s values: <br>
<!--                #2652DA-->
                <b><span style="color: rgba(10, 115, 255, 1);">"{{ partner_value_desc }}"</span></b>
            </p>
        </div>

        <div id="desire-panel">
            <div class="desire-item">
                <div class="text-container">
                    <span>Helpful</span>
                    <span class="tooltip" title="Whether you want to help others or not.">
                        <img src="../static/imgs/icon.svg" alt="info icon" class="icon">
                    </span>
                </div>
                <div class="bar">
                    <div class="scale-point">
                        <span class="side-emoji">üòà</span>
                        <span class="side-label">harmful</span>
                    </div>
                    <div class="scale-point">
                        <span class="side-emoji">üôÖüèª‚Äç‚ôÄÔ∏è</span>
                        <span class="side-label">unhelpful</span>
                    </div>
                    <div class="scale-point">
                        <span class="side-emoji">üëº</span>
                        <span class="side-label">helpful</span>
                    </div>
                    <div class="scale-point">
                        <span class="side-emoji">üëºüëº</span>
                        <span class="side-label">very helpful</span>
                    </div>
                </div>
            </div>
            <div class="desire-item">
                <div class="text-container">
                    <span>Social</span>
                    <span class="tooltip" title="Whether you prefer social interaction or not">
                        <img src="../static/imgs/icon.svg" alt="info icon" class="icon">
                    </span>
                </div>
                <div class="bar">
                    <div class="scale-point">
                        <span class="side-emoji">ü´£</span>
                        <span class="side-label">unsocial</span>
                    </div>
                    <div class="scale-point">
                        <span class="side-emoji">üòê</span>
                        <span class="side-label">neutral</span>
                    </div>
                    <div class="scale-point">
                        <span class="side-emoji">ü§ó</span>
                        <span class="side-label">social</span>
                    </div>
                </div>
            </div>
            <div class="desire-item">
                <div class="text-container">
                    <span>Active</span>
                    <span class="tooltip" title="Whether you prefer physical motion or not.">
                        <img src="../static/imgs/icon.svg" alt="info icon" class="icon">
                    </span>
                </div>
                <div class="bar">
                    <div class="scale-point">
                        <span class="side-emoji">üò¥</span>
                        <span class="side-label">inactive</span>
                    </div>
                    <div class="scale-point">
                        <span class="side-emoji">üßò</span>
                        <span class="side-label">neutral</span>
                    </div>
                    <div class="scale-point">
                        <span class="side-emoji">üèÉ</span>
                        <span class="side-label">active</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="content">
        <div id="game">
            <div class="center">
                <img id="render" src="../static/imgs/logo_400.png" onclick="getClickPosition(event)">
                <div id="emoji-container-1">
                    <div class="emoji-row">
                        <span class="emoji" data-attribute="helpful">üëº</span>
                        <span class="emoji divider" data-attribute="social">ü§ó</span>
                        <span class="emoji divider" data-attribute="active">üèÉ</span>
                    </div>
                    <div class="agent-name">agent 1</div>
                </div>
                <div id="emoji-container-2">
                    <div class="emoji-row">
                        <span class="emoji" data-attribute="helpful">üëº</span>
                        <span class="emoji divider" data-attribute="social">ü§ó</span>
                        <span class="emoji divider" data-attribute="active">üèÉ</span>
                    </div>
                    <div class="agent-name">agent 2</div>
                </div>
            </div>
            <div id="bottom">
                <div id="bar">
                    Setting up the game ‚Ä¶
                </div>
                <div id="divider"></div>
                <div id="labels" style="text-align: left;" >
                    <div class="label" id="2.1" style="display:none;">
                        <div id="layout-2-1" class="layout-label">
                            <div id="2.1.1" style="display:flex">
                                <p id="name11" class="top-para"></p>
                                <p><span id="selectedOtherIntention"></span></p>
                                <select id="sel_other_high_intent1-0" onchange="OnIntent2Change()" >
                                        <option selected="selected" value="NA">NA</option>
                                        <option value='Observe' disabled>Observe</option>
                                        <option value='Get' disabled>Get..From..</option>
                                        <option value='Give' disabled>Give..To..</option>
                                        <option value='Find' disabled>Find</option>
                                        <option value='Open' disabled>Open</option>
                                        <option value='PutInto' disabled>Put..Into..</option>
                                        <option value='PutOnto' disabled>Put..Onto..</option>
                                        <option value='PlayWith' disabled>Play..With..</option>
                                        <option value='RespondTo' disabled>RespondTo</option>
                                        <option value='Inform' disabled>Inform</option>
                                        <option value="Greet" disabled>Greet</option>
                                        <option value='Help' disabled>Help</option>
                                        <option value='RequestHelp' disabled>RequestHelp</option>
                                        <option value='Harm' disabled>Harm</option>
                                    </select>
                                <select id="sel_other_high_intent1-1" disabled onchange="OnInt2Para1Change()">
                                        </select>
                                <select id="sel_other_high_intent1-2" disabled onchange="OnInt2Para2Change()">
                                    </select>
                                <select id="sel_other_high_intent1-3" disabled onchange="OnInt2Para3Change()">
                                        </select>
                                <select id="sel_other_high_intent1-4" disabled onchange="OnInt2Para4Change()">
                                        </select>
                                <br />

                                <p id="name12" class="bottom-para"></p>
                                <div style="margin-bottom: 1em;">
                                    <label for="sel_other_desire_active" style="font-size: 1.2em;">Active:</label>
                                    <span style="margin-right: 5px; margin-left: 5px" class="value-span">inactive</span>
                                    <input id="sel_other_desire_active" class="active-field" type="range" min="0" max="1" step="0.1" value="0.5" oninput="updateValue('active-value', this.value)"/>
                                    <span style="margin-left: 5px;" class="value-span">active</span>
                                    <span id="active-value" style="display: none">0.5</span>
                                </div>
                                <div style="margin-bottom: 1em;">
                                    <label for="sel_other_desire_social" style="font-size: 1.2em;">Social:</label>
                                    <span style="margin-right: 5px; margin-left: 5px" class="value-span">unsocial</span>
                                    <input id="sel_other_desire_social" class="social-field" type="range" min="0" max="1" step="0.1" value="0.5" oninput="updateValue('social-value', this.value)"/>
                                    <span style="margin-left: 5px;" class="value-span">social</span>
                                    <span id="social-value" style="display: none">0.5</span>
                                </div>
                                <div style="margin-bottom: 1em;">
                                    <label for="sel_other_desire_helpful" style="font-size: 1.2em;">Helpful:</label>
                                    <span style="margin-right: 5px; margin-left: 5px" class="value-span">harmful</span>
                                    <input id="sel_other_desire_helpful" class="helpful-field" type="range" min="0" max="1" step="0.1" value="0.5" oninput="updateValue('helpful-value', this.value)"/>
                                    <span style="margin-left: 5px;" class="value-span">very helpful</span>
                                    <span id="helpful-value" style="display: none">0.5</span>
                                </div>
                            </div>
                            <button class="label-btn" name="intent_inverse" id="btn1" onclick="Label1Done()">Done</button>
                        </div>
                    </div>
                    <div class="label" id="2.2" style="display:none;">
                        <div id="layout-2-2" class="layout-label">
                            <div id="layout-2-2-sel">
                                <p class="top-para">My intention: </p>
                                <p><span id="selectedMyIntention"></span></p>
                                <select id="sel_your_high_intent-0" onchange="OnIntentChange()">
                                        <option selected="selected" value="NA">NA</option>
                                        <option value='Observe' disabled>Observe</option>
                                        <option value='Get' disabled>Get..From..</option>
                                        <option value='Give' disabled>Give..To..</option>
                                        <option value='Find' disabled>Find</option>
                                        <option value='Open' disabled>Open</option>
                                        <option value='PutInto' disabled>Put..Into..</option>
                                        <option value='PutOnto' disabled>Put..Onto..</option>
                                        <option value='PlayWith' disabled>Play..With..</option>
                                        <option value='RespondTo' disabled>RespondTo</option>
                                        <option value='Inform' disabled>Inform</option>
                                        <option value="Greet" disabled>Greet</option>
                                        <option value='Help' disabled>Help</option>
                                        <option value='RequestHelp' disabled>RequestHelp</option>
                                        <option value='Harm' disabled>Harm</option>
                                </select>
                                <select id="sel_your_high_intent-1" disabled onchange="OnIntPara1Change()"></select>
                                <select id="sel_your_high_intent-2" disabled onchange="OnIntPara2Change()"></select>
                                <select id="sel_your_high_intent-3" disabled onchange="OnIntPara3Change()"></select>
                                <select id="sel_your_high_intent-4" disabled onchange="OnIntPara4Change()"></select>
                                <br />
                            </div>
                            <button class="label-btn" name="intent" id="btn2" onclick="Label2Done()">Done</button>
                        </div>
                    </div>
                    <div class="label" id="2.3" style="display:none;">
                        <div id="layout-2-3" class="layout-label">
                            <div id="layout-2-3-sel">
                                <p class="top-para">My action:</p>
                                <select name="action" id="sel_action" onchange="OnActionChange()" class="selector">
                                        <option value="ActionWait"> Wait </option>
                                        <option value="ActionExplore"> Explore </option>
                                        <option value="ActionRotateTo"> RotateTo </option>
                                        <option value="ActionPlay"> Play </option>
                                        <option value="ActionMoveTo"> MoveTo </option>
                                        <option value="ActionMoveToAttention"> MoveToAttention </option>
                                        <option value="ActionUnlock"> Unlock </option>
                                        <option value="ActionOpen"> Open </option>
                                        <option value="ActionClose"> Close </option>
                                        <option value="ActionGrab"> Grab </option>
                                        <option value="ActionGiveTo"> GiveTo </option>
                                        <option value="ActionWaveHand"> WaveHand </option>
                                        <option value="ActionPointTo"> PointTo </option>
                                        <option value="ActionFollowGaze"> FollowGaze </option>
                                        <option value="ActionNodHead"> NodHead </option>
                                        <option value="ActionShakeHead"> ShakeHead </option>
                                        <option value="ActionPutInto"> PutInto </option>
                                        <option value="ActionPutOnto"> PutOnto </option>
                                        <option value="ActionFollowPointing"> FollowPointing </option>
                                        <option value="ActionEat"> Eat </option>
                                        <option value="ActionSmash"> Smash </option>
                                        <option value="ActionSpeak"> Speak </option>
                                        <option value="ActionPerform"> Perform </option>
                                </select>
                                <select name="para1" id="sel_action_para1" class="selector1" disabled>
                                    </select>
                                <select name="para2" id='sel_action_para2' class="selector2" disabled>
                                    </select>
                            </div>
                            <button class="label-btn" name="run" id="run">Next</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!--  dynamic change  -->
    <div id="status-bar">
    <!--    <div id="status-bar" style="display:none;" >-->
        <div id="round-container">
            <div id="round">- ROUND -</div>
        </div>

<!--        <div id="score-status" style="display: none">-->
        <!-- todo control test ËØ¥ËøôÈÉ®ÂàÜ‰∏çÊòæÁ§∫ -->
<!--        <div id="score-status">-->
        <div id="score-status" style="display: none">
            <p id="my-score">My Score:</p>
            <div id="status-text">
                <p id="goal-completion">#1 Goal Completion: 0</p>
                <p id="value-consistency">#2 Value Consistency: 0.00%</p>
                <p id="active-score">   #a active value score: 0.00</p>
                <p id="social-score">   #b social value score: 0.00</p>
                <p id="self-goal-score">#c self-goal value score: 0.00</p>
                <p id="helpful-score">  #d helpful value score: 0.00</p>
            </div>
        </div>

        <div id="help-btn">
            <a href="wiki" target="_blank" class="help-button">‚ùìHelp</a>
        </div>
    </div>

    <a id="new" href="{{ url_for('web_base.reset') }}" style="display:none;">reset(ÂΩìÂâçÂè™ÂÅöÊµãËØïÁî®)</a>
    <a id="break" href="{{ url_for('web_base.show_break') }}" style="display:none;">break</a>
    <a id="finish" href="{{ url_for('web_base.finish') }}" style="display:none;">finish</a>

    <script>
        // $('#new').attr("disabled", true);
        myresize();
        showAndHide();
        // ÊØè 5 ÁßíÊ£ÄÊü•‰∏ÄÊ¨° sid (session id)
        setInterval(checkSid, 5000);

        agentId = {{ agent_id | int }};
        partnerId = {{ partner_agent_id | int }};

        const active = {{ my_value.active | float }};
        const social = {{ my_value.social | float }};
        const helpful = {{ my_value.helpful | float }};

        decideValueBars(active, social, helpful);

        const valuesPosRatio = {{ values_pos_ratio | tojson }};

        // control test mode
        const control_test = {{ control_test | tojson }};

        if (control_test) {
            // display to show
            $('#other-value-para').css('display', 'block');
            $('#value-consistency').text('#2 Value Consistency: NA');
            $('#score-status').css('display', 'none');
        } else {
            delete valuesPosRatio[partnerId];
        }

        setEmojiPosition(agentId, valuesPosRatio);

        const partnerActive = {{ partner_value.active | float }};
        const partnerSocial = {{ partner_value.social | float }};
        const partnerHelpful = {{ partner_value.helpful | float }};

        decideValueEmoji(agentId, active, social, helpful);

        const imageElement = document.getElementById('render');
        isMouseOverImage = false;
        imageElement.addEventListener('mousemove', function(event) {
            isMouseOverImage = true;
            onMouseMove(event);
        });
        imageElement.addEventListener('mouseleave', function(event) {
            isMouseOverImage = false;
            hideClickMarker(event);
        });

        window.addEventListener('resize', () => {
            setEmojiPosition(agentId, valuesPosRatio);
        });

        // from first page load
        var action_option_dict = {{ action_option_dict | tojson }};

        console.log('before action_option_dict: ', action_option_dict);
        action_option_dict = transformActionOptionDict(action_option_dict);
        console.log('after action_option_dict: ', action_option_dict);

        var world_id_name_dict = {{ world_id_name_dict | tojson }};

        // intent: means high level, tasks: means low level
        var intent_option_dict = {{ intent_option_dict | tojson }};

        // intent: means high level, tasks: means low level
        var other_intent_option_dict = {{ other_intent_option_dict | tojson }};

        var belief_agent_list = {{ belief_agent_list | tojson }};
        var mode = "{{ mode | string}}";

		var total_time = 20000;
		// ËÆ∞ÂΩï‰∏ä‰∏ÄÊ¨°Êèê‰∫§Êó∂ÁöÑÊØ´ÁßíÊï∞
		var last_submit_time = new Date().getTime();
		var wait_time = 0;
		var initialization = false;
		var finished_iteration = -1;
		var fix_time_per_round = true;

		// ÊòØÂê¶‰∏∫ÂΩìÂâç‰ªªÂä°ÁªàÊ≠¢ÁöÑÁä∂ÊÄÅÔºüÔºü
        var gb_survey_flag = false;
        // ÊòØÂê¶Ë¶ÅË∑≥ËΩ¨Âà∞ÊÑüË∞¢È°µÈù¢
        var gb_thanks_flag = false;

        var agent_name = "{{ agent_name }}";

        // Áî®‰∫éÂÖ®Â±ÄÊéßÂà∂‰∏ÄÂ±ÄÊ∏∏ÊàèÊòØÂê¶ÂÖ®ÈÉ® rendering ÁªìÊùüÔºõ
        var only_done_once = false;
        var latest_frame = "{{ latest_frame }}";

        ShowLabelingBox();

        ResetActionOptions(action_option_dict, action_name_dict);

        // intent init
        // your intent init
        let your_high_intent = document.getElementById("sel_your_high_intent-0");
        options = your_high_intent.options;

        for (let i = 0; i < options.length; ++i) {
            option = options[i];
            for (k in intent_option_dict) {
                for (item of intent_option_dict[k]) {
                    if (item.startsWith(option.value) || option.value == 'NA') {
                        option.disabled = false;
                    } else {
                    }
                }
            }
        }

        // other intent init
        if (belief_agent_list.length > 0) {
            let other_high_intent = document.getElementById("sel_other_high_intent1-0");
            options = other_high_intent.options;
            agent = belief_agent_list[0];
            option_dict = other_intent_option_dict[agent[0]];

            for (let i = 0; i < options.length; ++i) {
                option = options[i];
                for (k in option_dict) {
                    for (item of option_dict[k]) {
                        if (item.startsWith(option.value) || option.value == 'NA') {
                            option.disabled = false;
                        } else {
                        }
                    }
                }
            }
        }


		$('#btn1').click(function() {
			var bar = document.getElementById('bar');
			bar.innerHTML = 'Updating your own intents.';
		});
		
		$('#btn2').click(function() {
			var bar = document.getElementById('bar');
			bar.innerHTML = 'Planning my next-step action. ';
		});

		showAndHideOptions();

        // send user input to server
        $('#run').click(function() {

            // immediately disable the button and waiting for the response
            $('#run').attr("disabled", true);

            var sel_action = $('#sel_action').val();
            var sel_action_para1 = $('#sel_action_para1').val();
            var sel_action_para2 = $('#sel_action_para2').val();

            if (['ActionRotateTo', 'ActionMoveTo'].includes(sel_action)) {
                if (sel_action_para1 == 'X: Y: ') {
                    alert("Please click on the specific location with the mouse!");
                    $('#run').attr("disabled", false);
                    return;
                } else if (sel_action_para1 == null) {
                    alert("Please choose or click the target!");
                    $('#run').attr("disabled", false);
                    return;
                }
            }

            console.log("sel_action", sel_action);

            if (sel_action === "" || sel_action === null || sel_action === undefined) {
                alert("Please select a valid action!!!");
                $('#run').attr("disabled", false);
                return;
            }


            // your_high_intent
            // other_high_intent
            your_high_intent = '';
            other_high_intent = '';

            if (belief_agent_list.length > 0) {
                belief_agent_id = belief_agent_list[0][0];
                other_high_intent = belief_agent_id + "|";
            }

            for (let i = 0; i < 5; ++i){
                val = $('#sel_your_high_intent-' + i).val();
                if (val != null) {
                    value = world_id_name_dict[val];
                    if (value == undefined) {
                        value = val;
                    }
                    your_high_intent += value + '-';
                }
                val = $('#sel_other_high_intent1-' + i).val();
                if (val != null) {
                    value = world_id_name_dict[val];
                    if (value == undefined) {
                        value = val;
                    }
                    other_high_intent += value + '-';
                }
            }

            if (your_high_intent.endsWith('-')) {
                your_high_intent = your_high_intent.slice(0, your_high_intent.length-1);
            }

            if (other_high_intent.endsWith('-')) {
                other_high_intent = other_high_intent.slice(0, other_high_intent.length-1);
            }

			// ÁÆ°ÁêÜÁä∂ÊÄÅÊ†è
			// ‰∏ÄËΩÆÊó∂Èó¥ - ÊâÄÁî®Êó∂Èó¥ = Á≠âÂæÖÊó∂Èó¥
			wait_time = total_time - (new Date().getTime() - last_submit_time)
			if (wait_time < 0) {
				wait_time = 0;
			}
			if (!fix_time_per_round) {
				wait_time = 0;
			}
			// console.log(wait_time);
			// console.log(new Date().getTime());
			state_bar_management();

            $.ajax({
                url: '/' + mode + '/step',
                type: 'POST',
                dataType: 'json',
                data: {
                    'action': sel_action,
                    'param1': sel_action_para1,
                    'param2': sel_action_para2,
                    'your_high_intent': your_high_intent,
                    'other_high_intent': other_high_intent,
                    'other_desire': getDesireValue('#sel_other_desire_active') + ',' + 
                                    getDesireValue('#sel_other_desire_social') + ',' + 
                                    getDesireValue('#sel_other_desire_helpful'),
                },
                async: true,
                success: function(recv) {

                    // ÊéßÂà∂‰∏ÄËΩÆÊ∏∏ÊàèÁöÑÁªìÊùüÁä∂ÊÄÅÔºõ
                    only_done_once = false;
                    // console.log(recv.message);

                    // action selection
                    action_option_dict = recv.action_option_dict;
                    action_option_dict = transformActionOptionDict(action_option_dict);

                    let com = document.getElementById("sel_action");
                    options = com.options;

                    // intent & tasks
                    intent_option_dict = recv.intent_option_dict;

                    // other intent & tasks
                    other_intent_option_dict = recv.other_intent_option_dict;

                    // belief_agent_list
                    belief_agent_list = recv.belief_agent_list;

                    // Âä®‰ΩúÊòØÂê¶ÂêàÊ≥ï
                    invalid = recv.invalid;

                    if (invalid) {
                        console.log("action failed: " + recv.hint);
                        alert("action failed: " + recv.hint);
                        $('#run').attr("disabled", false);
						
						var bar = document.getElementById('bar');
						bar.innerHTML = 'Planning my next-step action.';
						
                        return;
                    }

                    // status bar
                    // $('#goal-completion').html('#1 Goal Completion: ' + (recv.goal_completion ? 1 : 0));
                    // var $valueElement = $('#value-consistency');
                    // var displayValue = control_test ? 'NA' : (recv.value_consistency * 100).toFixed(2) + '%';
                    // $valueElement.html('#2 Value Consistency: ' + displayValue);

                    ResetActionOptions(action_option_dict, action_name_dict);

                    // ÊâãÂä®Ë∞ÉÁî®ÂáΩÊï∞ÔºåÊîπÂèòÂä®‰ΩúÂèÇÊï∞
                    OnActionChange();

                    OnIntentUpdate();

                    OnIntent2Update();
                    OnInt2Para1Change();
                    OnInt2Para2Change();
                    OnInt2Para3Change();

                    showAndHideOptions();

                    // auto save last action selected, maybe invalid this step, fixme
                    autoSaveActionOptions(sel_action, sel_action_para1, sel_action_para2, 
                                          action_option_dict, action_name_dict);
                }
            });
        });
        
        let isExit = false;
        $(
            function() {
                // call();
                s = new Date().getTime();
                // 10ms => 50ms
                // 100fps => 20fps
                const exitInterval = setInterval(function() {
                    if (!isExit) {
                        call();
                    } else {
                        clearInterval(exitInterval);
                    }
                }, 50);
                e = new Date().getTime();
                console.log('call duration: %d', s-e);
            }
        );

        OnActionChange();
        OnIntentChange();
        showAndHideOptions();

        var first_flag = true;

        // ÁõëÊéßÊú¨ËΩÆ render ÊòØÂê¶ÁªìÊùüÔºåÂõ†‰∏∫Â≠òÂú®Âë®ÊúüÊÄßËΩÆËØ¢
        // ÊéßÂà∂ render ÁªìÊùüÊó∂ÁöÑÈÄªËæë‰ªÖÊâßË°å‰∏ÄÊ¨°
        var flag_dict = {};
        var rendering_flag = false;
        var active_status = false;

        // ËΩÆËØ¢ÊäìÂêéÁ´ØÊï∞ÊçÆ
        function call() {
            $.ajax({
                url: '/' + mode + '/interact',
                type: "POST",
                dataType: "json",
                async: false,
                success: function(recv) {

                    // update frame
                    if (recv.frame_data != '') {
                        latest_frame = recv.frame_data;
                    }
                    if (latest_frame != null) {
                        $('#render').attr("src", latest_frame);
                    }
                    
                    // 0906, move the following code to this round rendering finished
                    // update action, 
                    // updated_action_option_dict = transformActionOptionDict(recv.action_option_dict);
                    // if ('action_option_dict' in recv && !isDeepEqual(action_option_dict, recv.action_option_dict)) {
                    //     action_option_dict = updated_action_option_dict;
                    //     updateActionOptions(action_option_dict, action_name_array);
                    // }
                    // // temp fix
                    // if (['ActionRotateTo', 'ActionMoveTo'].includes($('#sel_action').val())) {
                    //     if ($('#sel_action_para1').val() == null) {
                    //         $('#sel_action_para1').val(action_option_dict[$('#sel_action').val()][0][0][1]);
                    //     }
                    // }

                    setEmojiPosition(agentId, recv.values_pos_ratio);

                    finished_flag = recv.finished_flag;
                    iteration = recv.iteration;
                    to_finish_page = recv.to_finish_page;

                    active_status = recv.active;
					sending = recv.sending;
					fix_time_per_round = recv.fix_time_per_round;
                    
                    const roundElement = document.querySelector('#round');
                    const newRoundContent = `- ROUND ${Math.ceil(iteration / 2)} -`;
                    if (roundElement.innerHTML !== newRoundContent) {
                        roundElement.innerHTML = newRoundContent;
                    }
                    
                    // ZoomImage(iteration);

					// sending == getting observation
					if (sending && initialization) {
						var bar = document.getElementById('bar');
						bar.innerHTML = 'Collecting observations.';
					}

                    // Ëß¶Âèë‰∏ã‰∏ÄÊ¨°‰ªªÂä°
					var finished_tasks = recv.finished_tasks;
                    // ÊéßÂà∂valuesÊ†áÊ≥®ÁöÑÊòæÁ§∫ÂíåÈöêËóè
                    toggleValuesVisibility(!control_test && (gb_survey_flag || ((Math.ceil((iteration+1) / 2)) % SHOW_VALUE_BARS_PER_ITERATION === 0)));

                    // u2u mode: Áî®Êà∑ÊØèÊ¨°Âè™ÈúÄË¶ÅÂèÇ‰∏é‰∏ÄÊ¨°
                    // recv.done == 0 || recv.done == 2: ÊÑèÂë≥ÁùÄÂΩìÂâç‰ªªÂä°Â∑≤ÁªèÂÆåÊàê, 0: success, 2: max rounds
                    if (mode == 'u2u' && finished_flag && (recv.done == 0 || recv.done == 2) && !only_done_once) {

                        // gb_thanks_flag = gb_survey_flag 
                        if (!gb_survey_flag) {
                            // Ë∞ÉÊü•ÂØπdesireÁöÑ‰º∞ËÆ°
                            // ËøôÈáåÂè™ÊîπÂèòÁä∂ÊÄÅÂÄº
                            gb_survey_flag = true;

                            label1 = document.getElementById("2.1");
                            label2 = document.getElementById("2.2");
                            label3 = document.getElementById("2.3");

                            if (belief_agent_list.length > 0) {
                                toggleValuesVisibility(!control_test);
                                label1.style.display = 'flex';
                                label2.style.display = 'none';
                                label3.style.display = 'none';
                            } else {
                                toggleValuesVisibility(false);
                                label1.style.display = 'none';
                                label2.style.display = 'none';
                                label3.style.display = 'none';
                                gb_thanks_flag = true;
                            }
                        }

                        if (gb_thanks_flag) {
                            only_done_once = true;
                            result = confirm("You've finished this game!!!");
                            if (to_finish_page) {
                                document.getElementById("finish").click();
                            } else {
                                document.getElementById("break").click();
                            }
                        }
                    }

                    // for u2m
                    if (recv.done == 0 && finished_flag && !only_done_once && gb_thanks_flag) {
                        // alert("this task has been done!");
                        // $('#new').attr("disabled", false);
                        only_done_once = true;
                        alert("You've finished the " + finished_tasks + "/3 task, please go on");
                        document.getElementById("new").click();
                    } else if (recv.done == 2 && finished_flag && !only_done_once && gb_thanks_flag) {
                        only_done_once = true;
                        alert("The " + finished_tasks + "/3 task has reached the max rounds (30), please go on");
                        document.getElementById("new").click();
                    }

                    if (finished_tasks >= 3 && finished_flag && (recv.done == 0 || recv.done == 2) && !only_done_once && gb_thanks_flag) {
                        only_done_once = true;
                        result = confirm("You've finished all the assigned tasks, then you can choose to finish or play once again");
                        if (result == true) {
                            document.getElementById("new").click();
                        } else {
                            document.getElementById("finish").click();
                        }
                    }

                    if (mode == 'u2u') {
                        if (!finished_flag && !flag_dict[iteration]) {
                           CloseBeliefAgentLabel();
                        }

                        // current iteration finished, executed only once
                        if (finished_flag && !flag_dict[iteration]) {
                            
                            updated_action_option_dict = transformActionOptionDict(recv.action_option_dict);
                            if ('action_option_dict' in recv && !isDeepEqual(action_option_dict, recv.action_option_dict)) {
                                action_option_dict = updated_action_option_dict;
                                updateActionOptions(action_option_dict, action_name_array);
                            }
                            // temp fix
                            if (['ActionRotateTo', 'ActionMoveTo'].includes($('#sel_action').val())) {
                                if ($('#sel_action_para1').val() == null) {
                                    $('#sel_action_para1').val(action_option_dict[$('#sel_action').val()][0][0][1]);
                                }
                            }

                            rendering_flag = false;
                            const clickMarker = document.getElementById('click-marker');
                            if (clickMarker && clickMarker.style.display !== 'none') {
                                clickMarker.style.display = 'none';
                            }
                            isMarkerVisible = false;

							// Âú∫ÊôØÂàùÂßãÂåñ
							if (!initialization) {
								var bar = document.getElementById('bar');
								bar.innerHTML = 'Game started!';
								initialization = true;
							}

                            // alert('round ' + iteration + ' finished!');
                            flag_dict[iteration] = finished_flag;

                            if (active_status) {
                                ShowLabelingBox();
                                if (belief_agent_list.length > 0) {
                                    var bar = document.getElementById('bar');
                                    if (document.getElementById('sel_other_desire_active').style.display != 'none') {
                                        bar.innerHTML = 'Inferring the other player\'s intents and values.';
                                    } else {
                                        bar.innerHTML = 'Inferring the other player\'s intents.';
                                    }
								}
								else {
									var bar = document.getElementById('bar');
									bar.innerHTML = 'Updating my own intents.';
								}
                            }
							if ((!active_status) && (finished_iteration != iteration)) {
								waitting_interact();
							}

							finished_iteration = iteration;

                            $('#run').attr("disabled", false);
                        } else {
                            if (document.getElementById('2.3').style.display != 'none') {
                                const clickMarker = document.getElementById('click-marker');
                                if ((isMouseOverImage || isMarkerVisible) && ['ActionMoveTo', 'ActionRotateTo'].includes($('#sel_action').val())) {
                                    if (clickMarker && clickMarker.style.display == 'none') {
                                        clickMarker.style.display = 'block';
                                    }
                                } else {
                                    if (clickMarker && clickMarker.style.display != 'none') {
                                        clickMarker.style.display = 'none';
                                    }
                                }
                            }
                        }
                    }
                    // u2m mode
                    else {
                        // when rendering, donot show the label box;
                        if (!finished_flag) {
                           CloseBeliefAgentLabel();
                        }

                        // current iteration finished, executed only once
                        if (finished_flag && !flag_dict[iteration]) {
                            rendering_flag = false;
                            flag_dict[iteration] = finished_flag;
                            ShowLabelingBox();
                            $('#run').attr("disabled", false);
                            // $('#run').attr("style", "color:black;");
							last_submit_time = new Date().getTime();
							// console.log(last_submit_time);

							if (belief_agent_list.length > 0) {
                                var bar = document.getElementById('bar');
                                if (document.getElementById('sel_other_desire_active').style.display != 'none') {
                                    bar.innerHTML = 'Inferring the other player\'s intents and values.';
                                }
                                else {
                                    bar.innerHTML = 'Inferring the other player\'s intents.';
                                }
							}
							else {
								var bar = document.getElementById('bar');
								bar.innerHTML = 'Updating my own intent.';
							}

							if (!initialization) {
								initialization = true;
							}

                        }
                    }
                }
            })
        };
    
        let isRefreshing = false;

        window.addEventListener('beforeunload', function (e) {
            isRefreshing = true;
            setTimeout(function() {
                isRefreshing = false;
            }, 0);
        });

        window.addEventListener('pagehide', function (e) {
            if (!isRefreshing) {
                const sid = document.cookie.match(/sid=([^;]+)/);
                isExit = true;
                if (sid) {
                    console.log('ÂèëÈÄÅ user_leave ËØ∑Ê±ÇÔºåsid:', sid[1]);
                    fetch('/user_leave', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            sid: sid[1]
                        }),
                        keepalive: true
                    }).then(response => response.json())
                    .then(data => console.log('user_leave ÂìçÂ∫î:', data))
                    .catch(error => console.error('ÈîôËØØ:', error));
                } else {
                    console.error('Âú® cookie ‰∏≠Êú™ÊâæÂà∞ sid');
                }
            }
        });
    </script>

</body>
</html>